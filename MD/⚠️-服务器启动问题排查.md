# ⚠️ 服务器启动问题排查

## 🔍 问题现象

你遇到的问题：
- 启动脚本运行了，但服务器实际上没有启动
- 诊断工具显示"Failed to fetch"或"服务器未运行"
- 浏览器无法连接到 http://localhost:3001

## 📋 排查步骤

### 步骤1：检查Node.js是否安装

```cmd
node --version
```

应该显示版本号，如 `v18.x.x` 或更高版本。

如果提示"不是内部或外部命令"，请安装Node.js：
- 下载地址：https://nodejs.org/
- 选择LTS版本

### 步骤2：检查依赖是否安装

```cmd
npm install
```

这会安装所有需要的依赖包（express, multer, cors等）。

### 步骤3：手动启动服务器

打开命令行（CMD或PowerShell），进入项目目录，运行：

```cmd
node unified-server.js
```

**正常情况**应该看到：
```
========================================
🚀 统一博客服务器已启动
📡 服务地址: http://localhost:3001
📁 数据目录: D:\文件\blog\data
========================================
```

**如果没有任何输出**，说明服务器启动失败。

### 步骤4：查看错误信息

如果服务器启动失败，通常会显示错误信息。常见错误：

#### 错误1：端口被占用
```
Error: listen EADDRINUSE: address already in use :::3001
```

**解决方法**：
1. 关闭占用端口3001的程序
2. 或者修改 `unified-server.js` 中的端口号：
   ```javascript
   const PORT = 3002; // 改为其他端口
   ```

#### 错误2：模块未找到
```
Error: Cannot find module 'express'
```

**解决方法**：
```cmd
npm install
```

#### 错误3：权限问题
```
Error: EACCES: permission denied
```

**解决方法**：
- 以管理员身份运行命令行
- 或检查文件夹权限

### 步骤5：使用测试服务器

如果unified-server.js无法启动，可以先用测试服务器验证环境：

```cmd
node test-minimal-server.js
```

这个简化版服务器更容易诊断问题。

### 步骤6：检查防火墙

Windows防火墙可能阻止Node.js访问网络。

**解决方法**：
1. 打开"Windows Defender 防火墙"
2. 点击"允许应用通过防火墙"
3. 找到"Node.js"并勾选"专用"和"公用"
4. 如果没有Node.js，点击"允许其他应用"添加

### 步骤7：使用诊断工具

打开浏览器，访问：
```
file:///D:/文件/blog/check-server-status.html
```

或双击打开 `check-server-status.html` 文件。

这个工具会自动检测服务器状态并给出建议。

## 🛠️ 快速修复方案

### 方案1：使用测试服务器

如果unified-server.js有问题，可以临时使用测试服务器：

```cmd
node test-minimal-server.js
```

这个服务器只提供基本的API功能，但足够测试图片上传。

### 方案2：重新安装依赖

```cmd
# 删除node_modules文件夹
rmdir /s /q node_modules

# 重新安装
npm install
```

### 方案3：检查文件完整性

unified-server.js文件可能损坏。检查文件大小：

```cmd
dir unified-server.js
```

文件应该有几十KB大小。如果是0字节，说明文件损坏了。

## 📝 手动启动步骤（推荐）

不要使用bat脚本，手动启动更容易看到错误：

### 1. 打开两个命令行窗口

**窗口1 - 统一服务器**：
```cmd
cd D:\文件\blog
node unified-server.js
```

保持这个窗口打开，应该看到服务器启动信息。

**窗口2 - 前端服务器**：
```cmd
cd D:\文件\blog
npx http-server -p 8080
```

保持这个窗口打开，应该看到：
```
Starting up http-server, serving ./
Available on:
  http://127.0.0.1:8080
```

### 2. 测试连接

打开浏览器，访问：
- 统一服务器：http://localhost:3001/api/health
- 前端服务器：http://localhost:8080/blog/

如果都能访问，说明服务器启动成功！

## 🔧 常见问题

### Q1：为什么bat脚本启动后看不到输出？

A：bat脚本使用 `start` 命令在新窗口中启动服务器，但窗口可能立即关闭。建议手动启动以查看错误信息。

### Q2：如何确认服务器真的在运行？

A：运行测试脚本：
```cmd
node test-server-connection.js
```

或在浏览器访问：http://localhost:3001/api/health

### Q3：端口3001被占用怎么办？

A：查找占用端口的程序：
```cmd
netstat -ano | findstr :3001
```

记下最后一列的PID，然后：
```cmd
taskkill /PID <PID> /F
```

### Q4：图片上传显示成功但没有保存？

A：这是因为：
1. 文件上传到了服务器（uploads文件夹）
2. 但JSON记录没有保存（需要API服务器）

确保统一服务器（端口3001）正在运行。

## 📞 获取帮助

如果以上方法都无法解决问题，请：

1. 运行诊断工具：`check-server-status.html`
2. 查看浏览器控制台（F12）的错误信息
3. 查看命令行窗口的错误信息
4. 截图错误信息以便分析

## ✅ 成功标志

服务器正常运行时，你应该看到：

### 命令行输出
```
========================================
🚀 统一博客服务器已启动
📡 服务地址: http://localhost:3001
========================================
```

### 浏览器测试
访问 http://localhost:3001/api/health 应该显示：
```json
{
  "success": true,
  "message": "统一服务器运行正常",
  "timestamp": "2025-11-23T...",
  "services": {
    "api": "running",
    "upload": "running"
  }
}
```

### 诊断工具
`check-server-status.html` 应该显示：
- ✓ 统一服务器运行正常
- ✓ 前端服务器运行正常

---

**创建时间**: 2025-11-23  
**用途**: 服务器启动问题排查指南
